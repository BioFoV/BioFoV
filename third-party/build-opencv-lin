#!/bin/bash

################################################################################
#
# OpenCV Git pull/clone and compilation
#
################################################################################

ROOT=`pwd`
CPUS=`nproc`
VERSION="2.4.9"
SRCFLD="src-$VERSION"
GITURL="https://github.com/Itseez/opencv.git"
PKGCONF="../../linux-install/lib/pkgconfig"

if [ ! -d opencv ]; then
  mkdir opencv
fi
cd opencv

# Get source
if [ ! -d $SRCFLD ]; then
  if git clone --branch $VERSION --depth 1 $GITURL $SRCFLD;then
    echo "cloned"
  else
    echo "clone failed"
    exit
  fi
else
  cd $SRCFLD
  git checkout master
  if git pull; then
    echo "pulled"
    cd ..
  else
    echo "pull failed"
    exit
  fi
fi

# Checkout the right tag
cd $SRCFLD
git checkout $VERSION
cd ..

# Build for linux
if [ ! -d linux-build ]; then
  mkdir linux-build
fi
cd linux-build
cmake -D CMAKE_BUILD_TYPE=RELEASE \
      -D CMAKE_INSTALL_PREFIX=../linux-install \
      -D WITH_CUDA=OFF \
      -D ENABLE_FAST_MATH=ON \
      -D BUILD_SHARED_LIBS=OFF \
      -D BUILD_opencv_java=OFF \
      -D BUILD_opencv_python=OFF \
      -D BUILD_opencv_legacy=OFF \
      -D BUILD_DOCS=OFF \
      -D BUILD_TESTS=OFF \
      -D BUILD_PERF_TESTS=OFF \
      -D BUILD_FAT_JAVA_LIB=OFF \
      -D BUILD_TBB=ON \
      -D BUILD_PNG=ON \
      -D BUILD_JPEG=ON \
      -D BUILD_TIFF=ON \
      -D BUILD_JASPER=ON \
      -D BUILD_ZLIB=ON \
      -D WITH_TBB=ON \
      -D WITH_GSTREAMER=OFF \
      -D WITH_V4L=OFF \
      -D WITH_LIBV4L=OFF \
      -D CMAKE_CXX_FLAGS="-I/home/miguel/Tese/Code/framework/third-party/linux-install/include -L/home/miguel/Tese/Code/framework/third-party/linux-install/lib" \
      -D CMAKE_C_FLAGS="-I/home/miguel/Tese/Code/framework/third-party/linux-install/include -L/home/miguel/Tese/Code/framework/third-party/linux-install/lib" \
      ../$SRCFLD/

make -j$CPUS install
cd ../..

