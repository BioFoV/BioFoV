#!/bin/bash

################################################################################
#
# OpenCV Git pull/clone and compilation
#
################################################################################

CPUS="4"
VERSION="2.4.9"

if [ ! -d opencv ]; then
  mkdir opencv
fi
cd opencv

# Get source
if [ ! -d src ]; then
  if git clone https://github.com/Itseez/opencv.git src;then
    echo "cloned"
  else
    echo "clone failed"
    exit
  fi
else
  cd src
  if git pull; then
    echo "pulled"
    cd ..
  else
    echo "pull failed"
    exit
  fi
fi

# Checkout the right tag
git checkout $VERSION

# Build for windows
if [ ! -d windows-build ]; then
  mkdir windows-build
fi
cd windows-build
#cmake ../src/ -DCMAKE_TOOLCHAIN_FILE=../../../build_windows/Toolchain-cross-mingw32-linux.cmake
cmake -D CMAKE_BUILD_TYPE=RELEASE \
      -D CMAKE_INSTALL_PREFIX=../windows-install \
      -D CMAKE_TOOLCHAIN_FILE=../../../build-windows/Toolchain-cross-mingw32-linux.cmake \
      -D BUILD_SHARED_LIBS=OFF \
	  -D WITH_V4L=ON \
      ../src/
make install
cd ..

# Build for linux
if [ ! -d linux-build ]; then
  mkdir linux-build
fi
cd linux-build
#cmake -D WITH_CUDA=OFF ../src
cmake -D CMAKE_BUILD_TYPE=RELEASE \
      -D CMAKE_INSTALL_PREFIX=../linux-install \
      -D WITH_CUDA=OFF \
      -D BUILD_SHARED_LIBS=OFF \
      ../src/
make -j$CPUS install
cd ../..

